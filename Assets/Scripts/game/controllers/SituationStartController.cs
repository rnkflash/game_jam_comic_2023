using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using StaticData;
using TMPro;
using UnityEngine;
using Random = UnityEngine.Random;

public enum SituationStartControllerState
{
  Start,
  Exit
}

public class SituationStartController : MonoBehaviour
{
  private SituationStartControllerState state;
  public Cards cards;
  

  public IEnumerator StartNextSituation()
  {
    var availableCards = GetAvailableCards();

    List<string> newCards = new List<string>();
    List<string> removedCards = new List<string>();
    List<string> remainedCards = new List<string>();
    availableCards.ForEach(c=>{
      if (!Player.Instance.dealtCards.Contains(c.id)) {
        newCards.Add(c.id);
      }
    });
    Player.Instance.dealtCards.ForEach(cid=>{
      if (!availableCards.Any(c=>c.id == cid)) {
        removedCards.Add(cid);
      } else {
        remainedCards.Add(cid);
      }
    });
    Player.Instance.dealtCards = remainedCards.Concat(newCards).ToList();
    
    if (newCards.Count > 0) {
      cards.AddCards(newCards.Count);
      while (cards.state != Cards.State.hidden) {
        yield return null;
      }
        
    }

    ReignsTypeCard selectedCard;
    var countCards = availableCards.Count();
    if (countCards == 0)
      selectedCard = null;
    else {
      selectedCard = availableCards.ElementAt(Random.Range(0, availableCards.Count - 1));
    }

    if (selectedCard != null) {
      Player.Instance.usedCards.Add(selectedCard.id);
      Player.Instance.prevDialog = -1;
      Player.Instance.dialog = selectedCard.dialogs[0].id;
    }

    Player.Instance.card = selectedCard;

    state = SituationStartControllerState.Exit;
    while (state != SituationStartControllerState.Exit)
    {
      yield return null;
    }
  }

  private List<ReignsTypeCard> GetAvailableCards() {
    var availableCards = CardsArray.Instance.newCards.Where(card =>
      !Player.Instance.usedCards.Any(id => id == card.id) 
      && card.enabled
      && PlayerHasMetConditions(card.conditions)
    ).ToList();

    return availableCards.OrderByDescending(o=>o.conditions.priority).ToList()
        .OrderBy(o=>o.conditions.resources.Find(r=>r.resource == Resource.distance)?.min ?? 0).ToList();
  }

    private bool PlayerHasMetConditions(ReignsTypeCard.Condition conditions)
    {
      var resourceCondition = conditions.resources.All(condition => {
          var value = Player.Instance.GetResource(condition.resource);
          return value >= condition.min && value <= condition.max;
      });

      var triggerConditions = conditions.triggers.All(trigger => {
        var have = Player.Instance.triggers.Contains(trigger.trigger);
        return trigger.have == have;
      });

      return resourceCondition && triggerConditions;
    }
}